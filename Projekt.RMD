---
title: "Project 1, Phase 1"
author: "Agnieszka Sitko, Annanina Koster, Rafa≈Ç Cylwa, Piotr Obarski"
date: "Modele liniowe i mieszane"
output: 
  html_document:
  toc: TRUE
pdf_document:
  toc: yes
---
# Preparing data to analysis

Firstly we launch load library agricolae which is needed to perform post-hoc test used later and we load data.
```{r}
library(agricolae)
load("~/Modele liniowe i mieszane/projekt 1/clinical.cb.rda")
load("~/Modele liniowe i mieszane/projekt 1/expression.cb1.rda")
load("~/Modele liniowe i mieszane/projekt 1/expression.cb2.rda")
```
We merge data contained in files expression.cb1 and expression.cb2, and then standarize codes of patients in file clinical.cb in order to have the same type of names as in file expression. 
```{r}
expression <- rbind(expression.cb1, expression.cb2)
remove(expression.cb1, expression.cb2)
clinical.cb$sampleID<-sub("-", ".", clinical.cb$sampleID)
clinical.cb$sampleID<-sub("-", ".", clinical.cb$sampleID)
clinical.cb$sampleID<-sub("-", ".", clinical.cb$sampleID)
```


```{r}
# rownames(clinical.cb)<-clinical.cb$sampleID
# clinical.cb <-clinical.cb[,-1]

rownames(expression)<- expression$Sample
expression <- expression[, -1]

t_expression <- t(expression)
t_expression <- as.data.frame(t_expression)

# clinical.cb$id<-rownames(clinical.cb)

colnames(clinical.cb)[1]<-"id"
t_expression$id<- rownames(t_expression)
data<- merge(clinical.cb, t_expression, by="id")
```
# Analyzing data

## Performing post-hoc test
```{r}
colnames(data)[18] <- "CancerType"
CancerType <- data$CancerType

nrofgroups <- 0
normality<-1
cook<-0

# length(colnames(data))
# to perform test I in loop there is 200, but eventually should be length(colnames(data))
for (i in 30:200) {
  x <- data[,i]
  model = aov(x ~ CancerType)
  # in Scheffe test we do not need equal numbers of observations in groups as well as in LSD test, but we have many groups, and Scheffe is more conservative, so we will get less number of genes, what I think is quite good, because ultimately such a quantititave analysis leads to quality analysis
  nrofgroups[i]<-match(tail(scheffe.test(model, "CancerType", console = FALSE)$groups$M,1), letters)
  normality[i]<-(shapiro.test(rstandard(model))$p.value>=0.05)
  cook[i]<-max(cooks.distance(model))
}
```
The results of a one-way ANOVA can be considered reliable as long as the following assumptions are met:<br/>

Response variable residuals are normally distributed (or approximately normally distributed).<br/>
Samples are independent.<br/>
Variances of populations are equal.<br/>
Responses for a given group are independent and identically distributed normal random variables (not a simple random sample (SRS)).<br/>
ANOVA is a relatively robust procedure with respect to violations of the normality assumption.
## Analysis of model and conclusions
```{r}
# I think we can add a few more tests about validity of our model, especially we can add
# sth to be able to generate interesting graphs, since he said that he likes graphs
# need to check normality and equal variances of populations
# use bartlett.test(x, CancerType)
hist(nrofgroups[30:length(nrofgroups)])
boxplot(cook[30:length(cook)], ylim=c(0, 0.1))
boxplot(cook[30:length(cook)], ylim=c(0, 1))
hist(cook[30:length(cook)]) # need to be fixed
which(normality==FALSE)
length(which(normality==FALSE))/(i-30)

colnames(data)[nrofgroups>7 & (is.na(nrofgroups) == FALSE)] # from histogram we see that it is better to put 7
```